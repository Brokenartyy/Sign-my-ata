<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Admin Panel</title>
</head>
<body>

<h2>Admin Panel</h2>

<div id="loginBox">
  <input id="email" placeholder="Email admin">
  <input id="password" type="password" placeholder="Password">
  <button onclick="login()">Login</button>
</div>

<div id="adminBox" hidden>
  <h3>Balas Pesan</h3>
  <div id="messages"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getAuth,
  signInWithEmailAndPassword,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

import {
  getFirestore,
  collection,
  onSnapshot,
  updateDoc,
  doc,
  query,
  orderBy
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCxzqdHlEFi5lIuen7vW9u2cxNbe3mPiio",
  authDomain: "pony-ata.firebaseapp.com",
  projectId: "pony-ata"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ðŸ‘‰ LOGIN
loginBtn.onclick = async () => {
  try {
    await signInWithEmailAndPassword(
      auth,
      email.value,
      password.value
    );
  } catch (e) {
    alert("âŒ Login gagal");
  }
};

// ðŸ‘‰ GATE UTAMA
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    // BELUM LOGIN â†’ CUMA LIHAT LOGIN
    loginBox.hidden = false;
    adminBox.hidden = true;
    title.textContent = "ðŸ”’ Admin Login";
    return;
  }

  // SUDAH LOGIN â†’ ADMIN PANEL
  loginBox.hidden = true;
  adminBox.hidden = false;
  title.textContent = "ðŸ‘‘ Admin Panel";

  const q = query(
    collection(db, "messages"),
    orderBy("createdAt", "desc")
  );

  onSnapshot(q, (snap) => {
    messages.innerHTML = "";
    snap.forEach(d => {
      const data = d.data();
      const el = document.createElement("div");

      el.innerHTML = `
        <p><b>${data.name}</b></p>
        <div>${data.content}</div>
        <textarea placeholder="Balasan admin...">${data.reply?.text || ""}</textarea>
        <button>Reply</button>
      `;

      el.querySelector("button").onclick = async () => {
        await updateDoc(doc(db, "messages", d.id), {
          reply: { text: el.querySelector("textarea").value }
        });
      };

      messages.appendChild(el);
    });
  });
});
</script>

</body>
</html>
